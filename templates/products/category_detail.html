<!-- templates/products/category_detail.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}{{ category.name }} | Corrison Store{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="{% url 'core:index' %}" class="text-gray-700 hover:text-blue-600">
                    <i class="fas fa-home mr-2"></i>Home
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="{% url 'products:catalog' %}" class="text-gray-700 hover:text-blue-600">
                        Products
                    </a>
                </div>
            </li>
            {% if category.parent %}
            <li>
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <a href="{% url 'products:category_detail' category.parent.slug %}" class="text-gray-700 hover:text-blue-600">
                        {{ category.parent.name }}
                    </a>
                </div>
            </li>
            {% endif %}
            <li aria-current="page">
                <div class="flex items-center">
                    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                    <span class="text-gray-500">{{ category.name }}</span>
                </div>
            </li>
        </ol>
    </nav>

    <!-- Category Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-4">{{ category.name }}</h1>
        {% if category.description %}
            <div class="text-gray-600">{{ category.description }}</div>
        {% endif %}
        
        {% if category.children.exists %}
            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-3">Subcategories</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    {% for subcategory in category.children.all %}
                        {% if subcategory.is_active %}
                            <a href="{% url 'products:category_detail' subcategory.slug %}" 
                               class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition duration-300 flex items-center">
                                {% if subcategory.image %}
                                    <img src="{{ subcategory.image.url }}" alt="{{ subcategory.name }}" class="w-10 h-10 object-cover rounded-full mr-3">
                                {% else %}
                                    <div class="w-10 h-10 bg-gray-200 rounded-full mr-3 flex items-center justify-center">
                                        <i class="fas fa-folder text-gray-400"></i>
                                    </div>
                                {% endif %}
                                <span>{{ subcategory.name }}</span>
                            </a>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>

    <div class="flex flex-col md:flex-row">
        <!-- Filters Sidebar -->
        <div class="w-full md:w-1/4 md:pr-6 mb-6 md:mb-0">
            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <h3 class="font-bold text-lg mb-4">Filters</h3>
                
                <form id="filter-form" method="GET" action="{% url 'products:category_detail' category.slug %}">
                    <!-- Price Range -->
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">Price Range</h4>
                        <div class="flex space-x-2">
                            <div class="w-1/2">
                                <label class="sr-only">Min Price</label>
                                <input type="number" name="min_price" placeholder="Min" value="{{ filters.min_price }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded">
                            </div>
                            <div class="w-1/2">
                                <label class="sr-only">Max Price</label>
                                <input type="number" name="max_price" placeholder="Max" value="{{ filters.max_price }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sort By -->
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">Sort By</h4>
                        <select name="sort" class="w-full px-3 py-2 border border-gray-300 rounded">
                            <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>Newest</option>
                            <option value="price_low" {% if filters.sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                            <option value="price_high" {% if filters.sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                            <option value="name_asc" {% if filters.sort == 'name_asc' %}selected{% endif %}>Name: A to Z</option>
                            <option value="name_desc" {% if filters.sort == 'name_desc' %}selected{% endif %}>Name: Z to A</option>
                        </select>
                    </div>
                    
                    <!-- Filter Checkboxes -->
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">Availability</h4>
                        <div class="flex items-center mb-2">
                            <input type="checkbox" name="on_sale" id="on-sale" value="true" {% if filters.on_sale %}checked{% endif %}
                                   class="mr-2">
                            <label for="on-sale">On Sale ({{ filter_options.on_sale.count }})</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="in_stock" id="in-stock" value="true" {% if filters.in_stock %}checked{% endif %}
                                   class="mr-2">
                            <label for="in-stock">In Stock ({{ filter_options.in_stock.count }})</label>
                        </div>
                    </div>
                    
                    <!-- Attribute Filters (dynamic based on available attributes) -->
                    {% if filter_options.attributes %}
                        {% for attribute in filter_options.attributes %}
                            <div class="mb-4">
                                <h4 class="font-semibold mb-2">{{ attribute.name }}</h4>
                                {% for value in attribute.values %}
                                    <div class="flex items-center mb-1">
                                        <input type="checkbox" name="attr_{{ attribute.id }}" id="attr-{{ attribute.id }}-{{ forloop.counter }}" 
                                               value="{{ value.value }}" {% if filters.attr|default:''|stringformat:'s'|slice:'5:' == attribute.id|stringformat:'s' and filters.attr_value == value.value %}checked{% endif %}
                                               class="mr-2">
                                        <label for="attr-{{ attribute.id }}-{{ forloop.counter }}">{{ value.value }} ({{ value.product_count }})</label>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Filter Buttons -->
                    <div class="flex space-x-2 mt-6">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Apply Filters
                        </button>
                        <a href="{% url 'products:category_detail' category.slug %}" 
                           class="border border-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-100">
                            Clear Filters
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Products Grid -->
        <div class="w-full md:w-3/4">
            <div class="flex justify-between items-center mb-6">
                <div class="text-sm text-gray-600">
                    {{ products.paginator.count }} products found
                </div>
                
                <!-- Mobile Filters Button -->
                <button class="md:hidden flex items-center text-gray-700 hover:text-blue-600" id="mobile-filter-button">
                    <i class="fas fa-filter mr-1"></i> Filters
                </button>
            </div>
            
            {% if not products %}
                <div class="bg-white p-8 rounded-lg shadow text-center">
                    <h3 class="text-xl font-semibold mb-2">No products found</h3>
                    <p class="text-gray-600 mb-4">Try adjusting your filters or browse our other categories.</p>
                    <a href="{% url 'products:catalog' %}" class="text-blue-600 hover:underline">View all products</a>
                </div>
            {% else %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for product in products %}
                        {% include 'components/product_card.html' with product=product %}
                    {% endfor %}
                </div>
                
                <!-- Pagination -->
                {% if products.has_other_pages %}
                    <div class="mt-8 flex justify-center">
                        {% include 'components/pagination.html' with page_obj=products %}
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<!-- Mobile Filters Drawer (hidden by default) -->
<div class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" id="mobile-filter-overlay"></div>
<div class="fixed top-0 right-0 h-full w-4/5 max-w-xs bg-white z-50 transform translate-x-full transition-transform duration-300" id="mobile-filters">
    <div class="p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg">Filters</h3>
            <button class="text-gray-500 hover:text-gray-700" id="close-filters">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Filter form (copy of the sidebar filters) -->
        <form id="mobile-filter-form" method="GET" action="{% url 'products:category_detail' category.slug %}">
            <!-- Price Range -->
            <div class="mb-4">
                <h4 class="font-semibold mb-2">Price Range</h4>
                <div class="flex space-x-2">
                    <div class="w-1/2">
                        <label class="sr-only">Min Price</label>
                        <input type="number" name="min_price" placeholder="Min" value="{{ filters.min_price }}" 
                               class="w-full px-3 py-2 border border-gray-300 rounded">
                    </div>
                    <div class="w-1/2">
                        <label class="sr-only">Max Price</label>
                        <input type="number" name="max_price" placeholder="Max" value="{{ filters.max_price }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded">
                    </div>
                </div>
            </div>
            
            <!-- Sort By -->
            <div class="mb-4">
                <h4 class="font-semibold mb-2">Sort By</h4>
                <select name="sort" class="w-full px-3 py-2 border border-gray-300 rounded">
                    <option value="newest" {% if filters.sort == 'newest' %}selected{% endif %}>Newest</option>
                    <option value="price_low" {% if filters.sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                    <option value="price_high" {% if filters.sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                    <option value="name_asc" {% if filters.sort == 'name_asc' %}selected{% endif %}>Name: A to Z</option>
                    <option value="name_desc" {% if filters.sort == 'name_desc' %}selected{% endif %}>Name: Z to A</option>
                </select>
            </div>
            
            <!-- Other filters... -->
            
            <!-- Filter Buttons -->
            <div class="flex space-x-2 mt-6">
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex-grow">
                    Apply Filters
                </button>
                <a href="{% url 'products:category_detail' category.slug %}" 
                   class="border border-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-100">
                    Clear
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Mobile filters functionality
    const mobileFilterButton = document.getElementById('mobile-filter-button');
    const mobileFilters = document.getElementById('mobile-filters');
    const mobileFilterOverlay = document.getElementById('mobile-filter-overlay');
    const closeFilters = document.getElementById('close-filters');
    
    // Open mobile filters
    mobileFilterButton.addEventListener('click', function() {
        mobileFilters.classList.remove('translate-x-full');
        mobileFilterOverlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    });
    
    // Close mobile filters
    function closeMobileFilters() {
        mobileFilters.classList.add('translate-x-full');
        mobileFilterOverlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
    
    closeFilters.addEventListener('click', closeMobileFilters);
    mobileFilterOverlay.addEventListener('click', closeMobileFilters);
    
    // Synchronize filter form inputs
    const mainFilterForm = document.getElementById('filter-form');
    const mobileFilterForm = document.getElementById('mobile-filter-form');
    
    // Copy inputs from mobile form to main form
    mobileFilterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(mobileFilterForm);
        let queryString = '';
        
        for (const [name, value] of formData.entries()) {
            if (value) {
                if (queryString) {
                    queryString += '&';
                }
                queryString += encodeURIComponent(name) + '=' + encodeURIComponent(value);
            }
        }
        
        window.location.href = '{% url "products:category_detail" category.slug %}?' + queryString;
    });
</script>
{% endblock %}
