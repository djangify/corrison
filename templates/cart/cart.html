{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - Corrison Store{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold">Shopping Cart</h1>
        {% include 'components/breadcrumbs.html' with items=breadcrumbs %}
    </div>

    {% if items|length == 0 %}
        <div class="bg-white rounded-lg shadow-md p-8 text-center max-w-md mx-auto">
            <div class="w-20 h-20 bg-gray-100 rounded-full mx-auto flex items-center justify-center mb-4">
                <i class="fas fa-shopping-cart text-gray-400 text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Your Cart is Empty</h2>
            <p class="text-gray-600 mb-6">Looks like you haven't added any items to your cart yet.</p>
            <a href="{% url 'products:catalog' %}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded transition duration-200">
                Continue Shopping
            </a>
        </div>
    {% else %}
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Cart Items (Left Side) -->
            <div class="lg:col-span-8">
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="px-6 py-3 text-left text-gray-700 font-semibold">Product</th>
                                    <th class="px-6 py-3 text-center text-gray-700 font-semibold">Quantity</th>
                                    <th class="px-6 py-3 text-right text-gray-700 font-semibold">Price</th>
                                    <th class="px-6 py-3 text-right text-gray-700 font-semibold">Total</th>
                                    <th class="px-6 py-3 text-center text-gray-700 font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                {% for item in items %}
                                    <tr id="cart-item-{{ item.id }}" class="hover:bg-gray-50">
                                        <td class="px-6 py-4">
                                            <div class="flex items-center">
                                                <div class="w-16 h-16 flex-shrink-0 bg-gray-100 rounded overflow-hidden mr-4">
                                                    {% if item.product.main_image %}
                                                        <img src="{{ item.product.main_image.url }}" alt="{{ item.product.name }}" class="w-full h-full object-cover">
                                                    {% else %}
                                                        <div class="w-full h-full flex items-center justify-center text-gray-500">
                                                            <i class="fas fa-image"></i>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <h3 class="font-semibold">
                                                        <a href="{% url 'products:product_detail' item.product.slug %}" class="hover:text-blue-600">
                                                            {{ item.product.name }}
                                                        </a>
                                                    </h3>
                                                    {% if item.variant %}
                                                        <p class="text-sm text-gray-600">{{ item.variant }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex justify-center items-center">
                                                <button class="update-quantity-btn text-gray-500 hover:text-gray-700 focus:outline-none" data-action="decrease" data-item="{{ item.id }}">
                                                    <i class="fas fa-minus-circle"></i>
                                                </button>
                                                <input type="number" class="quantity-input mx-2 w-16 text-center border border-gray-300 rounded px-2 py-1" min="1" value="{{ item.quantity }}" data-item="{{ item.id }}">
                                                <button class="update-quantity-btn text-gray-500 hover:text-gray-700 focus:outline-none" data-action="increase" data-item="{{ item.id }}">
                                                    <i class="fas fa-plus-circle"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            ${{ item.unit_price }}
                                        </td>
                                        <td class="px-6 py-4 text-right font-semibold item-total" data-item="{{ item.id }}">
                                            ${{ item.total_price }}
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <button class="remove-item-btn text-red-500 hover:text-red-700 focus:outline-none" data-item="{{ item.id }}">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="flex justify-between items-center mt-6">
                    <a href="{% url 'products:catalog' %}" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-arrow-left mr-2"></i> Continue Shopping
                    </a>
                    <button id="clear-cart-btn" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash mr-2"></i> Clear Cart
                    </button>
                </div>
            </div>
            
            <!-- Cart Summary (Right Side) -->
            <div class="lg:col-span-4">
                <div class="bg-white rounded-lg shadow-md p-6 sticky top-6">
                    <h2 class="text-xl font-bold mb-4">Cart Summary</h2>
                    
                    <div class="space-y-2 mb-6">
                        <div class="flex justify-between">
                            <span>Subtotal</span>
                            <span id="cart-subtotal">${{ subtotal }}</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg pt-2 border-t border-gray-200">
                            <span>Total</span>
                            <span id="cart-total">${{ subtotal }}</span>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <a href="{% url 'checkout:checkout' %}" class="block w-full bg-blue-600 text-white text-center py-3 px-4 rounded font-semibold hover:bg-blue-700 transition duration-200">
                            Proceed to Checkout
                        </a>
                    </div>
                    
                    {% if user.is_authenticated == False %}
                        <div class="text-center text-sm text-gray-600">
                            <p>Already have an account?</p>
                            <a href="{% url 'accounts:login' %}?next={% url 'checkout:checkout' %}" class="text-blue-600 hover:text-blue-800">
                                Log in for a faster checkout
                            </a>
                        </div>
                    {% endif %}
                    
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600 mb-2">We Accept</p>
                        <div class="flex justify-center space-x-2">
                            <i class="fab fa-cc-visa text-blue-700 text-2xl"></i>
                            <i class="fab fa-cc-mastercard text-red-500 text-2xl"></i>
                            <i class="fab fa-cc-amex text-blue-500 text-2xl"></i>
                            <i class="fab fa-cc-discover text-orange-500 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{% if items|length > 0 %}
<script>
    // Update cart item quantity
    document.querySelectorAll('.update-quantity-btn').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item');
            const action = this.getAttribute('data-action');
            const inputElement = document.querySelector(`.quantity-input[data-item="${itemId}"]`);
            let quantity = parseInt(inputElement.value);
            
            if (action === 'increase') {
                quantity += 1;
            } else if (action === 'decrease') {
                quantity = Math.max(1, quantity - 1);
            }
            
            inputElement.value = quantity;
            updateCartItem(itemId, quantity);
        });
    });
    
    // Update cart when quantity input changes
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', function() {
            const itemId = this.getAttribute('data-item');
            const quantity = Math.max(1, parseInt(this.value));
            this.value = quantity; // Ensure the display matches what we're sending
            updateCartItem(itemId, quantity);
        });
    });
    
    // Remove item from cart
    document.querySelectorAll('.remove-item-btn').forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item');
            removeCartItem(itemId);
        });
    });
    
    // Clear cart
    document.getElementById('clear-cart-btn').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear your cart?')) {
            clearCart();
        }
    });
    
    // Update cart item via AJAX
    function updateCartItem(itemId, quantity) {
        fetch('{% url "cart:update_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                item_id: itemId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update item total and cart totals
                updateCartDisplay(data);
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    // Remove cart item via AJAX
    function removeCartItem(itemId) {
        fetch(`{% url "cart:remove_from_cart" "00000000-0000-0000-0000-000000000000" %}`.replace('00000000-0000-0000-0000-000000000000', itemId), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Remove item from DOM
                document.getElementById(`cart-item-${itemId}`).remove();
                updateCartDisplay(data);
                
                // If cart is empty, reload the page
                if (data.cart_count === 0) {
                    window.location.reload();
                }
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    // Clear cart via AJAX
    function clearCart() {
        fetch('{% url "cart:clear_cart" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reload the page to show empty cart
                window.location.reload();
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
    
    // Update cart display with new totals
    function updateCartDisplay(data) {
        // Update subtotal and total
        document.getElementById('cart-subtotal').textContent = `$${data.cart_total.toFixed(2)}`;
        document.getElementById('cart-total').textContent = `$${data.cart_total.toFixed(2)}`;
        
        // Update cart count in header
        const cartCountElement = document.querySelector('.fa-shopping-cart').nextElementSibling;
        cartCountElement.textContent = data.cart_count;
    }
</script>
{% endif %}
{% endblock %}
