{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout - Corrison Store{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold">Checkout</h1>
        {% include 'components/breadcrumbs.html' with items=breadcrumbs %}
    </div>

    {% if cart.items.count == 0 %}
        <div class="bg-blue-100 text-blue-700 p-4 rounded mb-6">
            Your cart is empty. Please add some items before checking out.
        </div>
        <div class="text-center my-12">
            <a href="{% url 'products:catalog' %}" class="bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700 transition duration-200">
                Continue Shopping
            </a>
        </div>
    {% else %}
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Checkout Form (Left Side) -->
            <div class="lg:col-span-8">
                <form id="checkout-form" method="POST" action="{% url 'checkout:process_checkout' %}">
                    {% csrf_token %}
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Contact Information</h2>
                        {% if not user.is_authenticated %}
                            <div class="mb-4">
                                <label for="email" class="block text-gray-700 mb-2">Email Address*</label>
                                <input type="email" id="email" name="email" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <p class="mt-2 text-sm text-gray-600">
                                    Already have an account? <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="text-blue-600">Login</a>
                                </p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Shipping Address -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Shipping Address</h2>
                        
                        {% if user.is_authenticated and addresses %}
                            <div class="mb-4">
                                <label class="block text-gray-700 mb-2">Select a Saved Address</label>
                                <select id="saved-shipping-address" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- Enter a new address --</option>
                                    {% for address in addresses %}
                                        <option value="{{ address.id }}" 
                                            data-name="{{ address.full_name }}"
                                            data-address1="{{ address.address_line1 }}"
                                            data-address2="{{ address.address_line2|default:'' }}"
                                            data-city="{{ address.city }}"
                                            data-state="{{ address.state_province }}"
                                            data-zip="{{ address.postal_code }}"
                                            data-country="{{ address.country }}"
                                            data-phone="{{ address.phone }}">
                                            {{ address.full_name }} - {{ address.address_line1 }}, {{ address.city }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        {% endif %}
                        
                        <div id="shipping-address-fields">
                            <div class="mb-4">
                                <label for="shipping_name" class="block text-gray-700 mb-2">Full Name*</label>
                                <input type="text" id="shipping_name" name="shipping_name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="mb-4">
                                <label for="shipping_address1" class="block text-gray-700 mb-2">Address Line 1*</label>
                                <input type="text" id="shipping_address1" name="shipping_address1" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                            <div class="mb-4">
                                <label for="shipping_address2" class="block text-gray-700 mb-2">Address Line 2</label>
                                <input type="text" id="shipping_address2" name="shipping_address2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="shipping_city" class="block text-gray-700 mb-2">City*</label>
                                    <input type="text" id="shipping_city" name="shipping_city" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label for="shipping_state" class="block text-gray-700 mb-2">State/Province*</label>
                                    <input type="text" id="shipping_state" name="shipping_state" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="shipping_zip" class="block text-gray-700 mb-2">Postal Code*</label>
                                    <input type="text" id="shipping_zip" name="shipping_zip" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label for="shipping_country" class="block text-gray-700 mb-2">Country*</label>
                                    <input type="text" id="shipping_country" name="shipping_country" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="shipping_phone" class="block text-gray-700 mb-2">Phone Number*</label>
                                <input type="tel" id="shipping_phone" name="shipping_phone" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            </div>
                        </div>
                    </div>

                    <!-- Billing Address -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <div class="flex items-center mb-4">
                            <input type="checkbox" id="same_as_shipping" name="same_as_billing" class="mr-2" checked>
                            <label for="same_as_shipping" class="text-gray-700">Billing address is the same as my shipping address</label>
                        </div>
                        
                        <div id="billing-address-fields" class="hidden">
                            {% if user.is_authenticated and addresses %}
                                <div class="mb-4">
                                    <label class="block text-gray-700 mb-2">Select a Saved Address</label>
                                    <select id="saved-billing-address" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">-- Enter a new address --</option>
                                        {% for address in addresses %}
                                            <option value="{{ address.id }}" 
                                                data-name="{{ address.full_name }}"
                                                data-address1="{{ address.address_line1 }}"
                                                data-address2="{{ address.address_line2|default:'' }}"
                                                data-city="{{ address.city }}"
                                                data-state="{{ address.state_province }}"
                                                data-zip="{{ address.postal_code }}"
                                                data-country="{{ address.country }}"
                                                data-phone="{{ address.phone }}">
                                                {{ address.full_name }} - {{ address.address_line1 }}, {{ address.city }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            {% endif %}
                            
                            <div class="mb-4">
                                <label for="billing_name" class="block text-gray-700 mb-2">Full Name*</label>
                                <input type="text" id="billing_name" name="billing_name" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="billing_address1" class="block text-gray-700 mb-2">Address Line 1*</label>
                                <input type="text" id="billing_address1" name="billing_address1" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="billing_address2" class="block text-gray-700 mb-2">Address Line 2</label>
                                <input type="text" id="billing_address2" name="billing_address2" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="billing_city" class="block text-gray-700 mb-2">City*</label>
                                    <input type="text" id="billing_city" name="billing_city" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="billing_state" class="block text-gray-700 mb-2">State/Province*</label>
                                    <input type="text" id="billing_state" name="billing_state" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="billing_zip" class="block text-gray-700 mb-2">Postal Code*</label>
                                    <input type="text" id="billing_zip" name="billing_zip" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="billing_country" class="block text-gray-700 mb-2">Country*</label>
                                    <input type="text" id="billing_country" name="billing_country" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="billing_phone" class="block text-gray-700 mb-2">Phone Number*</label>
                                <input type="tel" id="billing_phone" name="billing_phone" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Shipping Method -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Shipping Method</h2>
                        <div class="space-y-4">
                            <div class="flex items-center p-4 border border-gray-200 rounded-lg">
                                <input type="radio" id="shipping_standard" name="shipping_method" value="standard" class="mr-2" checked>
                                <label for="shipping_standard" class="flex-grow">
                                    <span class="block font-semibold">Standard Shipping</span>
                                    <span class="block text-sm text-gray-600">3-5 business days</span>
                                </label>
                                <span class="font-semibold">$5.00</span>
                            </div>
                            <div class="flex items-center p-4 border border-gray-200 rounded-lg">
                                <input type="radio" id="shipping_express" name="shipping_method" value="express" class="mr-2">
                                <label for="shipping_express" class="flex-grow">
                                    <span class="block font-semibold">Express Shipping</span>
                                    <span class="block text-sm text-gray-600">1-2 business days</span>
                                </label>
                                <span class="font-semibold">$15.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Notes -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Additional Notes</h2>
                        <div class="mb-4">
                            <label for="order_notes" class="block text-gray-700 mb-2">Order Notes (optional)</label>
                            <textarea id="order_notes" name="order_notes" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Notes about your order, e.g., special delivery instructions"></textarea>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Payment Method</h2>
                        <div class="space-y-4">
                            <div class="flex items-center p-4 border border-gray-200 rounded-lg">
                                <input type="radio" id="payment_stripe" name="payment_method" value="stripe" class="mr-2" checked>
                                <label for="payment_stripe" class="flex-grow">
                                    <span class="block font-semibold">Credit/Debit Card (Stripe)</span>
                                    <span class="block text-sm text-gray-600">Pay securely with your card via Stripe</span>
                                </label>
                                <span>
                                    <i class="fab fa-cc-visa text-blue-700 text-2xl mx-1"></i>
                                    <i class="fab fa-cc-mastercard text-red-500 text-2xl mx-1"></i>
                                    <i class="fab fa-cc-amex text-blue-500 text-2xl mx-1"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Order Summary (Right Side) -->
            <div class="lg:col-span-4">
                <div class="bg-white rounded-lg shadow-sm p-6 sticky top-6">
                    <h2 class="text-xl font-bold mb-4">Order Summary</h2>
                    
                    <div class="max-h-64 overflow-y-auto mb-4">
                        {% for item in items %}
                            <div class="flex py-4 {% if not forloop.last %}border-b border-gray-200{% endif %}">
                                <div class="w-16 h-16 flex-shrink-0 bg-gray-100 rounded overflow-hidden mr-4">
                                    {% if item.product.main_image %}
                                        <img src="{{ item.product.main_image.url }}" alt="{{ item.product.name }}" class="w-full h-full object-cover">
                                    {% else %}
                                        <div class="w-full h-full flex items-center justify-center text-gray-500">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow">
                                    <h3 class="font-semibold">{{ item.product.name }}</h3>
                                    {% if item.variant %}
                                        <p class="text-sm text-gray-600">{{ item.variant }}</p>
                                    {% endif %}
                                    <div class="flex justify-between mt-1">
                                        <span class="text-gray-600">Qty: {{ item.quantity }}</span>
                                        <span class="font-semibold">${{ item.total_price }}</span>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <div class="border-t border-gray-200 pt-4 space-y-2">
                        <div class="flex justify-between">
                            <span>Subtotal</span>
                            <span>${{ subtotal }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Shipping</span>
                            <span id="shipping-cost">$5.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Tax (10%)</span>
                            <span>${{ subtotal|floatformat:2|multiply:0.1 }}</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg pt-2 border-t border-gray-200">
                            <span>Total</span>
                            <span id="order-total">${{ subtotal|floatformat:2|add:5.00|add:subtotal|floatformat:2|multiply:0.1 }}</span>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button type="submit" form="checkout-form" class="w-full bg-blue-600 text-white py-3 px-4 rounded font-semibold hover:bg-blue-700 transition duration-200">
                            Proceed to Payment
                        </button>
                    </div>
                    
                    <div class="mt-4 text-center text-sm text-gray-600">
                        <p>By placing your order, you agree to our</p>
                        <p><a href="{% url 'core:terms_conditions' %}" class="text-blue-600">Terms and Conditions</a> and <a href="{% url 'core:privacy_policy' %}" class="text-blue-600">Privacy Policy</a></p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Toggle Billing Address when checkbox is clicked
    document.getElementById('same_as_shipping').addEventListener('change', function() {
        const billingFields = document.getElementById('billing-address-fields');
        if (this.checked) {
            billingFields.classList.add('hidden');
            // Clear required attribute from billing fields
            const billingInputs = billingFields.querySelectorAll('input');
            billingInputs.forEach(input => {
                input.required = false;
            });
        } else {
            billingFields.classList.remove('hidden');
            // Set required attribute on billing fields
            const billingInputs = billingFields.querySelectorAll('input');
            billingInputs.forEach(input => {
                if (input.id !== 'billing_address2') {
                    input.required = true;
                }
            });
        }
    });

    // Handle Shipping Method change
    const shippingMethods = document.querySelectorAll('input[name="shipping_method"]');
    shippingMethods.forEach(method => {
        method.addEventListener('change', function() {
            const shippingCost = this.value === 'express' ? 15.00 : 5.00;
            document.getElementById('shipping-cost').textContent = `$${shippingCost.toFixed(2)}`;
            
            // Recalculate total
            const subtotal = {{ subtotal|floatformat:2 }};
            const tax = subtotal * 0.1;
            const total = subtotal + shippingCost + tax;
            document.getElementById('order-total').textContent = `$${total.toFixed(2)}`;
        });
    });

    // Handle saved addresses
    if (document.getElementById('saved-shipping-address')) {
        document.getElementById('saved-shipping-address').addEventListener('change', function() {
            if (this.value) {
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById('shipping_name').value = selectedOption.dataset.name;
                document.getElementById('shipping_address1').value = selectedOption.dataset.address1;
                document.getElementById('shipping_address2').value = selectedOption.dataset.address2;
                document.getElementById('shipping_city').value = selectedOption.dataset.city;
                document.getElementById('shipping_state').value = selectedOption.dataset.state;
                document.getElementById('shipping_zip').value = selectedOption.dataset.zip;
                document.getElementById('shipping_country').value = selectedOption.dataset.country;
                document.getElementById('shipping_phone').value = selectedOption.dataset.phone;
            } else {
                // Clear fields
                document.getElementById('shipping-address-fields').querySelectorAll('input').forEach(input => {
                    input.value = '';
                });
            }
        });
    }

    if (document.getElementById('saved-billing-address')) {
        document.getElementById('saved-billing-address').addEventListener('change', function() {
            if (this.value) {
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById('billing_name').value = selectedOption.dataset.name;
                document.getElementById('billing_address1').value = selectedOption.dataset.address1;
                document.getElementById('billing_address2').value = selectedOption.dataset.address2;
                document.getElementById('billing_city').value = selectedOption.dataset.city;
                document.getElementById('billing_state').value = selectedOption.dataset.state;
                document.getElementById('billing_zip').value = selectedOption.dataset.zip;
                document.getElementById('billing_country').value = selectedOption.dataset.country;
                document.getElementById('billing_phone').value = selectedOption.dataset.phone;
            } else {
                // Clear fields
                document.getElementById('billing-address-fields').querySelectorAll('input').forEach(input => {
                    input.value = '';
                });
            }
        });
    }
</script>
{% endblock %}